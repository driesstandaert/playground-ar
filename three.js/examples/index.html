<!DOCTYPE html>
<meta name='viewport' content='width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0'>
<!-- three.js library -->
<script src='vendor/three.js/build/three.js'></script>
<script src='vendor/three.js/examples/js/libs/stats.min.js'></script>

<!-- three.js load GLTF -->
<script src='vendor/three.js/GLTFLoader.js'></script>

<!-- ar.js -->
<script src="../build/ar.js"></script>

<script>THREEx.ArToolkitContext.baseURL = '../'</script>

<!-- Bind window error for error handling -->
<script>
	window.addEventListener('error', function(event) {
		alert("ERROR: " + event.message + " at " + event.filename + " : " + event.lineno + " : " + event.colno);
	});
</script>

<body style='margin : 0px; overflow: hidden; font-family: Monospace;'>

<script>
	//////////////////////////////////////////////////////////////////////////////////
	//		Init
	//////////////////////////////////////////////////////////////////////////////////

	var renderer = new THREE.WebGLRenderer({
			antialias: true,
			alpha: true,
			precision: 'mediump',
	});

	var clock = new THREE.Clock();

	var mixers = [];

	renderer.setPixelRatio(window.devicePixelRatio);

	renderer.setClearColor(new THREE.Color('lightgrey'), 0)
	renderer.setSize( window.innerWidth, window.innerHeight );
	renderer.domElement.style.position = 'absolute'
	renderer.domElement.style.top = '0px'
	renderer.domElement.style.left = '0px'
	document.body.appendChild( renderer.domElement );

	// init scene and camera
	var scene = new THREE.Scene();

	//////////////////////////////////////////////////////////////////////////////////
	//		Initialize a basic camera
	//////////////////////////////////////////////////////////////////////////////////

	// Create a camera
	var camera = new THREE.Camera();
	scene.add(camera);

	var light = new THREE.AmbientLight(0xffffff);
	scene.add(light);

	////////////////////////////////////////////////////////////////////////////////
	//          handle arToolkitSource
	////////////////////////////////////////////////////////////////////////////////

	var artoolkitProfile = new THREEx.ArToolkitProfile()
	artoolkitProfile.sourceWebcam()
	// artoolkitProfile.sourceVideo(THREEx.ArToolkitContext.baseURL + './data/videos/headtracking.mp4').kanjiMarker();
	// artoolkitProfile.sourceImage(THREEx.ArToolkitContext.baseURL + './data/images/img.jpg').hiroMarker()

	var arToolkitSource = new THREEx.ArToolkitSource(artoolkitProfile.sourceParameters)

	arToolkitSource.init(function onReady(){
		onResize()
	})

	// handle resize
	window.addEventListener('resize', function(){
		onResize()
	})
	function onResize(){
		arToolkitSource.onResizeElement()
		arToolkitSource.copyElementSizeTo(renderer.domElement)
		if( arToolkitContext.arController !== null ){
			arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas)
		}
	}

	////////////////////////////////////////////////////////////////////////////////
	//          initialize arToolkitContext
	////////////////////////////////////////////////////////////////////////////////

	// create atToolkitContext
	var arToolkitContext = new THREEx.ArToolkitContext({
			detectionMode: 'mono',
			canvasWidth: 480,
			canvasHeight: 640,
	}, {
			sourceWidth: 480,
			sourceHeight: 640,
	})

	// initialize it
	arToolkitContext.init(function onCompleted(){
			// copy projection matrix to camera
			camera.projectionMatrix.copy( arToolkitContext.getProjectionMatrix() );
	})


	////////////////////////////////////////////////////////////////////////////////
	//          Create a ArMarkerControls
	////////////////////////////////////////////////////////////////////////////////

	var markerGroup = new THREE.Group
	scene.add(markerGroup)
	var markerControls = new THREEx.ArMarkerControls(arToolkitContext, markerGroup, {
		type : 'pattern',
		patternUrl : THREEx.ArToolkitContext.baseURL + '../../data/data/patt.hiro',
		changeMatrixMode: 'cameraTransformMatrix'
	})

	scene.visible = false

	var root = new THREE.Object3D();
	scene.add(root);


	// // build a smoothedControls
	// var smoothedGroup = new THREE.Group()
	// scene.add(smoothedGroup)
	// var smoothedControls = new THREEx.ArSmoothedControls(smoothedGroup)
	// onRenderFcts.push(function(delta){
	// 	smoothedControls.update(markerGroup)
	// })

	//////////////////////////////////////////////////////////////////////////////////
	//		add an object in the scene
	//////////////////////////////////////////////////////////////////////////////////

	var threeGLTFLoader = new THREE.GLTFLoader();
	var model;

	threeGLTFLoader.load("../../assets/animals/trout/scene.gltf", function (gltf) {
			model = gltf.scene.children[0];
			model.name = 'Trout';

			var animation = gltf.animations[0];
			var mixer = new THREE.AnimationMixer(model);
			mixers.push(mixer);
			var action = mixer.clipAction(animation);
			action.play();

			root.matrixAutoUpdate = false;
			root.add(model);

			model.position.z = 0;
			model.position.x = 0;
			model.position.y = 0;


			//////////////////////////////////////////////////////////////////////////////////
			//		render the whole thing on the page
			//////////////////////////////////////////////////////////////////////////////////

			var animate = function() {
					requestAnimationFrame(animate);

					if (mixers.length > 0) {
							for (var i = 0; i < mixers.length; i++) {
									mixers[i].update(clock.getDelta());
							}
					}

					if (!arToolkitSource.ready) {
							return;
					}

					arToolkitContext.update( arToolkitSource.domElement )

					// update scene.visible if the marker is seen
					scene.visible = camera.visible;

					renderer.render(scene, camera);
			};

			requestAnimationFrame(animate);
	}
);
</script></body>